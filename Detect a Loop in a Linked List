/*
Q2: Detect a Loop in a Linked List
Write a C function to detect if a linked list contains a cycle (loop).
If loop exists, print "Loop detected", otherwise "No loop found".

Demonstration builds a list and then creates a loop for testing.
*/

#include <stdio.h>
#include <stdlib.h>

typedef struct Node {
    int data;
    struct Node *next;
} Node;

Node* new_node(int v) {
    Node *n = malloc(sizeof(Node));
    if (!n) { perror("malloc"); exit(EXIT_FAILURE); }
    n->data = v; n->next = NULL; return n;
}

void append(Node **head, int v) {
    Node *n = new_node(v);
    if (!*head) { *head = n; return; }
    Node *t = *head; while (t->next) t = t->next; t->next = n;
}

void print_limited(Node *head, int limit) {
    int c = 0;
    while (head && c++ < limit) {
        printf("%d -> ", head->data);
        head = head->next;
    }
    printf("...\n");
}

/* Create a loop: tail->node_at_index (0-based). If index < 0 or out-of-range, no loop. */
void create_loop(Node *head, int index) {
    if (!head) return;
    Node *tail = head; int len = 1;
    while (tail->next) { tail = tail->next; len++; }
    if (index < 0) return;
    Node *target = head;
    for (int i = 0; i < index && target; ++i) target = target->next;
    if (target) tail->next = target;
}

/* Floyd's Tortoise and Hare */
int has_loop(Node *head) {
    Node *slow = head, *fast = head;
    while (fast && fast->next) {
        slow = slow->next;
        fast = fast->next->next;
        if (slow == fast) return 1; /* loop found */
    }
    return 0;
}

/* Free nodes safely (works only if no loop) */
void free_list(Node *head) {
    while (head) {
        Node *t = head; head = head->next; free(t);
    }
}

int main(void) {
    Node *head = NULL;
    for (int i = 1; i <= 7; ++i) append(&head, i);

    printf("List (truncated print):\n"); print_limited(head, 10);
    printf("Has loop? %s\n", has_loop(head) ? "Loop detected" : "No loop found");

    /* Create loop tail -> node index 2 (value 3) */
    create_loop(head, 2);
    printf("After creating loop, (printing truncated):\n"); print_limited(head, 15);
    printf("Has loop? %s\n", has_loop(head) ? "Loop detected" : "No loop found");

    /* Freeing is unsafe now because of loop; skipping free to avoid infinite loop.
       In real code, you'd remove the cycle first (detect + break), then free. */
    return 0;
}
